# Deploy GKE Autopilot cluster via Terraform.
# Trigger manually with inputs for project, region, cluster name, etc.
# Auth: Use WIF (vars WIF_PROVIDER, WIF_SA) or GOOGLE_CREDENTIALS secret. See docs/WIF_SETUP.md.

name: Deploy GKE Autopilot

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP project ID'
        required: true
        type: string
      region:
        description: 'GCP region (e.g. us-central1)'
        required: true
        type: string
      cluster_name:
        description: 'GKE Autopilot cluster name'
        required: true
        type: string
      release_channel:
        description: 'Release channel (REGULAR, RAPID, STABLE)'
        required: false
        default: 'REGULAR'
        type: choice
        options:
          - REGULAR
          - RAPID
          - STABLE
      network:
        description: 'VPC network name (default)'
        required: false
        default: 'default'
        type: string
      subnetwork:
        description: 'VPC subnetwork name (empty for default)'
        required: false
        default: ''
        type: string
      enable_private_cluster:
        description: 'Enable private cluster'
        required: false
        default: false
        type: boolean
      deletion_protection:
        description: 'Enable deletion protection'
        required: false
        default: false
        type: boolean
      apply:
        description: 'Run terraform apply (if false, plan only)'
        required: false
        default: false
        type: boolean

env:
  TF_WORKING_DIR: terraform

jobs:
  deploy:
    name: Terraform
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # required for Workload Identity Federation
      contents: read
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP (Workload Identity)
        if: vars.WIF_PROVIDER != '' && vars.WIF_SA != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SA }}

      - name: Authenticate to GCP (Service Account Key)
        if: vars.WIF_PROVIDER == '' || vars.WIF_SA == ''
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init
        env:
          # Use project ID (not number) so GCS backend and providers use correct project
          GOOGLE_CLOUD_PROJECT: ${{ inputs.project_id }}
          CLOUDSDK_CORE_PROJECT: ${{ inputs.project_id }}
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET || 'terraform-state-0222206' }}" \
            -backend-config="prefix=gke-autopilot/${{ inputs.project_id }}/${{ inputs.cluster_name }}"

      - name: Terraform Plan
        id: plan
        env:
          GOOGLE_CLOUD_PROJECT: ${{ inputs.project_id }}
          CLOUDSDK_CORE_PROJECT: ${{ inputs.project_id }}
        run: |
          terraform plan -no-color -input=false \
            -var="project_id=${{ inputs.project_id }}" \
            -var="region=${{ inputs.region }}" \
            -var="cluster_name=${{ inputs.cluster_name }}" \
            -var="release_channel=${{ inputs.release_channel }}" \
            -var="network=${{ inputs.network }}" \
            -var="subnetwork=${{ inputs.subnetwork }}" \
            -var="enable_private_cluster=${{ inputs.enable_private_cluster }}" \
            -var="deletion_protection=${{ inputs.deletion_protection }}" \
            -out=tfplan
        continue-on-error: true

      - name: Terraform Plan (output)
        run: terraform show -no-color tfplan || true

      - name: Terraform Apply
        if: inputs.apply == true && success()
        env:
          GOOGLE_CLOUD_PROJECT: ${{ inputs.project_id }}
          CLOUDSDK_CORE_PROJECT: ${{ inputs.project_id }}
        run: terraform apply -no-color -input=false -auto-approve tfplan

      - name: Outputs
        if: inputs.apply == true && success()
        env:
          GOOGLE_CLOUD_PROJECT: ${{ inputs.project_id }}
        run: terraform output -json
