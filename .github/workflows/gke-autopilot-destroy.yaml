# Destroy GKE Autopilot cluster via Terraform.
# Use the same project_id, region, cluster_name (and optional vars) as when the cluster was created.
# Auth: Use WIF (vars WIF_PROVIDER, WIF_SA) or GOOGLE_CREDENTIALS secret. See docs/WIF_SETUP.md.
# For destroy to work in CI, Terraform must use a remote backend (e.g. GCS) so state is available.

name: Destroy GKE Autopilot

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'GCP project ID (must match the cluster you are destroying)'
        required: true
        type: string
      region:
        description: 'GCP region (e.g. us-central1)'
        required: true
        type: string
      cluster_name:
        description: 'GKE Autopilot cluster name to destroy'
        required: true
        type: string
      release_channel:
        description: 'Release channel (must match cluster)'
        required: false
        default: 'REGULAR'
        type: choice
        options:
          - REGULAR
          - RAPID
          - STABLE
      network:
        description: 'VPC network name (must match cluster)'
        required: false
        default: 'default'
        type: string
      subnetwork:
        description: 'VPC subnetwork name (must match cluster)'
        required: false
        default: ''
        type: string
      enable_private_cluster:
        description: 'Private cluster (must match cluster)'
        required: false
        default: false
        type: boolean
      deletion_protection:
        description: 'Deletion protection (must match cluster)'
        required: false
        default: false
        type: boolean
      confirm_destroy:
        description: 'Check to confirm destruction of this cluster (required)'
        required: true
        default: false
        type: boolean

env:
  TF_WORKING_DIR: terraform

jobs:
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # required for Workload Identity Federation
      contents: read
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Require confirmation
        if: inputs.confirm_destroy != true
        run: |
          echo "::error::Set 'confirm_destroy' to true to run destroy."
          exit 1

      - name: Authenticate to GCP (Workload Identity)
        if: vars.WIF_PROVIDER != '' && vars.WIF_SA != ''
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: ${{ vars.WIF_SA }}

      - name: Authenticate to GCP (Service Account Key)
        if: vars.WIF_PROVIDER == '' || vars.WIF_SA == ''
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
          terraform_wrapper: false

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET || 'terraform-state-0222206' }}" \
            -backend-config="prefix=gke-autopilot/${{ inputs.project_id }}/${{ inputs.cluster_name }}"

      - name: Terraform Destroy
        run: |
          terraform destroy -no-color -input=false -auto-approve \
            -var="project_id=${{ inputs.project_id }}" \
            -var="region=${{ inputs.region }}" \
            -var="cluster_name=${{ inputs.cluster_name }}" \
            -var="release_channel=${{ inputs.release_channel }}" \
            -var="network=${{ inputs.network }}" \
            -var="subnetwork=${{ inputs.subnetwork }}" \
            -var="enable_private_cluster=${{ inputs.enable_private_cluster }}" \
            -var="deletion_protection=${{ inputs.deletion_protection }}"
